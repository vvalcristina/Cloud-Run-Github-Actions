name: Docker

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

    deploy:
        name: Setup Gcloud Account
        runs-on: ubuntu-latest
        env:
          IMAGE_NAME: gcr.io/${{ secrets.GCP_EMAIL}}/${{ secrets.GCP_APP_NAME }}"
        steps:
        - name: Setup SDK
          uses: google-github-actions/setup-gcloud@v0.2.0
          with:
            GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
            GCP_EMAIL: ${{ secrets.GCP_EMAIL }}
            GCP_APP_NAME: ${{ secrets.GCP_APP_NAME}}
            service_account_key: ${{ secrets.GCP_CREDENTIALS }}
            export_default_credentials: true 
            
        - name: Configure o Docker
          run: gcloud auth configure-docker --quiet

        - name: Build da imagem do Docker
          run: docker build --tag=gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_APP_NAME }} . --file=Dockerfile

        - name: Push Docker image
          run: docker push $IMAGE_NAME

        - name: Deploy Docker image
          run: gcloud run deploy ${{ secrets.GCP_PROJECT_ID }} --image $IMAGE_NAME --region us-east1 --platform managed
